= JPA n+1 select Issue

== Many To One 객체 조회시

=== EntityGraph

Repository
[source,java]
----
  @EntityGraph(attributePaths = "product")
  Page<Invest> findAllByUserId(Pageable pageable, String userId);
----

=== Fetch Join
Pageable 을 사용하면 다음과 같은 에러가 발생한다.
----
Caused by: org.hibernate.QueryException: query specified join fetching, but the owner of the fetched association was not present in the select list [FromElement{explicit,not a collection join,fetch join,fetch non-lazy
----
Non Pageable로 작성
[source,java]
----
  @Query("select o from Invest o join fetch o.product where o.userId = :userId")
  List<Invest> findAllByUserIdUsingQuery(@Param("userId") String userId);
----

=== QueryDsl
join 시 fetchJoin() 을 지정
----
  @Override
  public Page<Invest> findAllByUserIdUsingQueryDsl(Pageable pageable, String userId) {
    QInvest invest = QInvest.invest;
    JPAQuery<Invest> query = jpaQueryFactory.selectFrom(invest);
    query.join(invest.product, QProduct.product).fetchJoin();
    query.where(invest.userId.eq(userId));

    if(pageable.isPaged()) {
      query.offset(pageable.getOffset());
      query.limit(pageable.getPageSize());
    }

    List<Invest> invests = query.fetch();

    return new PageImpl<>(invests, pageable, query.fetchCount());
  }
----

=== QueryDsl Projection
실무에서는 이 방식을 주로 사용해왔다.
[source,code]
----
  public Page<InvestProjection> findAllByUserIdUsingQueryDslProjection(Pageable pageable, String userId) {
    QInvest invest = QInvest.invest;
    QProduct product = QProduct.product;

    JPAQuery<InvestProjection> query = new JPAQuery<>(entityManager);
    query.from(invest)
        .join(invest.product, product)
        .where(invest.userId.eq(userId));

    if(pageable.isPaged()) {
      query.offset(pageable.getOffset());
      query.limit(pageable.getPageSize());
    }

    List<InvestProjection> invests =
        query.select(new QInvestProjection(invest.userId, invest.id, product.id, product.title, invest.amount)).fetch();

    return new PageImpl<>(invests, pageable, query.fetchCount());
  }
}
----





== One To Many 객체 (Collection) 조회시

=== EntityGraph
@EntityGraph 를 직접 정의하면 다음 에러, @NamedEntityGraph 를 사용해야 함
----
Caused by: java.lang.IllegalArgumentException: The given JpaEntityGraph [name=orders, type=FETCH, attributePaths=[]] is not dynamic!
at org.springframework.util.Assert.isTrue(Assert.java:121)
----

[source,java]
Entity
----
@NamedEntityGraph(name = "User.couponsAndOrders",
    attributeNodes = {@NamedAttributeNode("coupons"), @NamedAttributeNode("orders")}

----

Repository
----
  @EntityGraph("User.couponsAndOrders")
  @Query("select o from User o")
  Page<User> findAllUsingEntityGraph(Pageable pageable);
----